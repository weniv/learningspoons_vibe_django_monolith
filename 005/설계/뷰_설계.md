# Django 블로그 뷰 설계 문서 (CBV)

## 목차
1. [뷰 개요](#뷰-개요)
2. [인증 관련 뷰](#인증-관련-뷰)
3. [게시글 관련 뷰](#게시글-관련-뷰)
4. [댓글 관련 뷰](#댓글-관련-뷰)
5. [기타 뷰](#기타-뷰)
6. [Mixin 및 권한 관리](#mixin-및-권한-관리)

---

## 뷰 개요

이 블로그 애플리케이션은 **Class Based View (CBV)** 방식으로 구현됩니다.

### 사용할 주요 제네릭 뷰
- **ListView**: 객체 목록 표시
- **DetailView**: 객체 상세 정보 표시
- **CreateView**: 객체 생성
- **UpdateView**: 객체 수정
- **DeleteView**: 객체 삭제
- **FormView**: 폼 처리
- **TemplateView**: 단순 템플릿 렌더링

### 사용할 주요 Mixin
- **LoginRequiredMixin**: 로그인 필수
- **UserPassesTestMixin**: 사용자 권한 검증

---

## 인증 관련 뷰

### 1. SignUpView (회원가입)
```python
from django.contrib.auth.forms import UserCreationForm
from django.views.generic import CreateView
from django.urls import reverse_lazy

class SignUpView(CreateView):
    form_class = UserCreationForm
    template_name = 'accounts/signup.html'
    success_url = reverse_lazy('accounts:login')
```

**주요 속성**:
- `form_class`: Django 기본 제공 UserCreationForm 사용
- `template_name`: 회원가입 폼 템플릿
- `success_url`: 회원가입 성공 시 로그인 페이지로 이동

**URL**: `/accounts/signup/`
**권한**: 누구나 접근 가능

---

### 2. LoginView (로그인)
```python
from django.contrib.auth.views import LoginView as DjangoLoginView

class LoginView(DjangoLoginView):
    template_name = 'accounts/login.html'
    redirect_authenticated_user = True
```

**주요 속성**:
- `template_name`: 로그인 폼 템플릿
- `redirect_authenticated_user`: 이미 로그인한 사용자는 자동 리다이렉트

**URL**: `/accounts/login/`
**권한**: 누구나 접근 가능 (로그인하지 않은 사용자)

**참고**: Django 내장 LoginView를 사용하며, settings.py에서 LOGIN_REDIRECT_URL 설정 필요

---

### 3. LogoutView (로그아웃)
```python
from django.contrib.auth.views import LogoutView as DjangoLogoutView

class LogoutView(DjangoLogoutView):
    next_page = 'main:home'
```

**주요 속성**:
- `next_page`: 로그아웃 후 이동할 페이지

**URL**: `/accounts/logout/`
**권한**: 로그인된 사용자만 접근 가능

---

## 게시글 관련 뷰

### 1. PostListView (게시글 목록)
```python
from django.views.generic import ListView
from .models import Post

class PostListView(ListView):
    model = Post
    template_name = 'blog/post_list.html'
    context_object_name = 'posts'
    paginate_by = 10

    def get_queryset(self):
        return Post.objects.filter(is_published=True).select_related('author').prefetch_related('tags')
```

**주요 속성**:
- `model`: Post 모델
- `template_name`: 게시글 목록 템플릿
- `context_object_name`: 템플릿에서 사용할 변수명
- `paginate_by`: 페이지당 10개씩 표시
- `get_queryset()`: 공개된 게시글만 조회, 성능 최적화 (select_related, prefetch_related)

**URL**: `/blog/`
**권한**: 누구나 접근 가능

**템플릿 컨텍스트**:
- `posts`: 게시글 목록
- `page_obj`: 페이지네이션 객체
- `is_paginated`: 페이지네이션 여부

---

### 2. PostDetailView (게시글 상세)
```python
from django.views.generic import DetailView
from .models import Post

class PostDetailView(DetailView):
    model = Post
    template_name = 'blog/post_detail.html'
    context_object_name = 'post'

    def get_queryset(self):
        return Post.objects.filter(is_published=True).select_related('author').prefetch_related('tags', 'comments__author')
```

**주요 속성**:
- `model`: Post 모델
- `template_name`: 게시글 상세 템플릿
- `context_object_name`: 템플릿에서 사용할 변수명
- `get_queryset()`: 공개된 게시글만 조회, 관련 데이터 최적화

**URL**: `/blog/<int:pk>/`
**권한**: 누구나 접근 가능 (공개 게시글만)

**템플릿 컨텍스트**:
- `post`: 게시글 객체
- `post.comments.all()`: 댓글 목록

---

### 3. PostCreateView (게시글 작성)
```python
from django.contrib.auth.mixins import LoginRequiredMixin
from django.views.generic import CreateView
from .models import Post
from .forms import PostForm

class PostCreateView(LoginRequiredMixin, CreateView):
    model = Post
    form_class = PostForm
    template_name = 'blog/post_form.html'

    def form_valid(self, form):
        form.instance.author = self.request.user
        return super().form_valid(form)
```

**주요 속성**:
- `model`: Post 모델
- `form_class`: PostForm (커스텀 폼)
- `template_name`: 게시글 작성 폼 템플릿
- `form_valid()`: 폼 검증 통과 시 작성자를 현재 로그인한 사용자로 설정

**URL**: `/blog/create/`
**권한**: 로그인된 사용자만 접근 가능

**Mixin**:
- `LoginRequiredMixin`: 로그인하지 않은 경우 로그인 페이지로 리다이렉트

---

### 4. PostUpdateView (게시글 수정)
```python
from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin
from django.views.generic import UpdateView
from .models import Post
from .forms import PostForm

class PostUpdateView(LoginRequiredMixin, UserPassesTestMixin, UpdateView):
    model = Post
    form_class = PostForm
    template_name = 'blog/post_form.html'

    def test_func(self):
        post = self.get_object()
        return self.request.user == post.author
```

**주요 속성**:
- `model`: Post 모델
- `form_class`: PostForm (커스텀 폼)
- `template_name`: 게시글 수정 폼 템플릿
- `test_func()`: 현재 사용자가 게시글 작성자인지 확인

**URL**: `/blog/<int:pk>/update/`
**권한**: 게시글 작성자만 수정 가능

**Mixin**:
- `LoginRequiredMixin`: 로그인 필수
- `UserPassesTestMixin`: 작성자만 접근 가능 (test_func 사용)

---

### 5. PostDeleteView (게시글 삭제)
```python
from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin
from django.views.generic import DeleteView
from django.urls import reverse_lazy
from .models import Post

class PostDeleteView(LoginRequiredMixin, UserPassesTestMixin, DeleteView):
    model = Post
    template_name = 'blog/post_confirm_delete.html'
    success_url = reverse_lazy('blog:post_list')

    def test_func(self):
        post = self.get_object()
        return self.request.user == post.author
```

**주요 속성**:
- `model`: Post 모델
- `template_name`: 삭제 확인 템플릿
- `success_url`: 삭제 후 게시글 목록 페이지로 이동
- `test_func()`: 현재 사용자가 게시글 작성자인지 확인

**URL**: `/blog/<int:pk>/delete/`
**권한**: 게시글 작성자만 삭제 가능

**Mixin**:
- `LoginRequiredMixin`: 로그인 필수
- `UserPassesTestMixin`: 작성자만 접근 가능

---

### 6. PostByTagListView (특정 태그 게시글 목록)
```python
from django.views.generic import ListView
from django.shortcuts import get_object_or_404
from .models import Post, Tag

class PostByTagListView(ListView):
    model = Post
    template_name = 'blog/post_list_by_tag.html'
    context_object_name = 'posts'
    paginate_by = 10

    def get_queryset(self):
        self.tag = get_object_or_404(Tag, slug=self.kwargs['slug'])
        return Post.objects.filter(
            tags=self.tag,
            is_published=True
        ).select_related('author').prefetch_related('tags')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['tag'] = self.tag
        return context
```

**주요 속성**:
- `model`: Post 모델
- `template_name`: 태그별 게시글 목록 템플릿
- `context_object_name`: 템플릿에서 사용할 변수명
- `paginate_by`: 페이지당 10개씩 표시
- `get_queryset()`: 특정 태그의 공개 게시글만 조회
- `get_context_data()`: 태그 정보 추가

**URL**: `/blog/tag/<str:slug>/`
**권한**: 누구나 접근 가능

**템플릿 컨텍스트**:
- `posts`: 게시글 목록
- `tag`: 태그 객체

---

## 댓글 관련 뷰

### 1. CommentCreateView (댓글 작성)
```python
from django.contrib.auth.mixins import LoginRequiredMixin
from django.views.generic import CreateView
from django.shortcuts import get_object_or_404
from .models import Comment, Post
from .forms import CommentForm

class CommentCreateView(LoginRequiredMixin, CreateView):
    model = Comment
    form_class = CommentForm

    def form_valid(self, form):
        post = get_object_or_404(Post, pk=self.kwargs['post_pk'])
        form.instance.author = self.request.user
        form.instance.post = post
        return super().form_valid(form)

    def get_success_url(self):
        return self.object.post.get_absolute_url()
```

**주요 속성**:
- `model`: Comment 모델
- `form_class`: CommentForm (커스텀 폼)
- `form_valid()`: 댓글 작성자와 게시글 자동 설정
- `get_success_url()`: 댓글 작성 후 게시글 상세 페이지로 이동

**URL**: `/blog/<int:post_pk>/comment/create/`
**권한**: 로그인된 사용자만 작성 가능

**Mixin**:
- `LoginRequiredMixin`: 로그인 필수

---

### 2. CommentUpdateView (댓글 수정)
```python
from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin
from django.views.generic import UpdateView
from .models import Comment
from .forms import CommentForm

class CommentUpdateView(LoginRequiredMixin, UserPassesTestMixin, UpdateView):
    model = Comment
    form_class = CommentForm
    template_name = 'blog/comment_form.html'

    def test_func(self):
        comment = self.get_object()
        return self.request.user == comment.author

    def get_success_url(self):
        return self.object.post.get_absolute_url()
```

**주요 속성**:
- `model`: Comment 모델
- `form_class`: CommentForm (커스텀 폼)
- `template_name`: 댓글 수정 폼 템플릿
- `test_func()`: 현재 사용자가 댓글 작성자인지 확인
- `get_success_url()`: 댓글 수정 후 게시글 상세 페이지로 이동

**URL**: `/blog/comment/<int:pk>/update/`
**권한**: 댓글 작성자만 수정 가능

**Mixin**:
- `LoginRequiredMixin`: 로그인 필수
- `UserPassesTestMixin`: 작성자만 접근 가능

---

### 3. CommentDeleteView (댓글 삭제)
```python
from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin
from django.views.generic import DeleteView
from .models import Comment

class CommentDeleteView(LoginRequiredMixin, UserPassesTestMixin, DeleteView):
    model = Comment
    template_name = 'blog/comment_confirm_delete.html'

    def test_func(self):
        comment = self.get_object()
        return self.request.user == comment.author

    def get_success_url(self):
        return self.object.post.get_absolute_url()
```

**주요 속성**:
- `model`: Comment 모델
- `template_name`: 댓글 삭제 확인 템플릿
- `test_func()`: 현재 사용자가 댓글 작성자인지 확인
- `get_success_url()`: 댓글 삭제 후 게시글 상세 페이지로 이동

**URL**: `/blog/comment/<int:pk>/delete/`
**권한**: 댓글 작성자만 삭제 가능

**Mixin**:
- `LoginRequiredMixin`: 로그인 필수
- `UserPassesTestMixin`: 작성자만 접근 가능

---

## 기타 뷰

### 1. HomeView (홈 페이지)
```python
from django.views.generic import TemplateView

class HomeView(TemplateView):
    template_name = 'main/home.html'
```

**URL**: `/`
**권한**: 누구나 접근 가능

---

### 2. AboutView (소개 페이지)
```python
from django.views.generic import TemplateView

class AboutView(TemplateView):
    template_name = 'main/about.html'
```

**URL**: `/about/`
**권한**: 누구나 접근 가능

---

### 3. ContactView (연락처 페이지)
```python
from django.views.generic import TemplateView

class ContactView(TemplateView):
    template_name = 'main/contact.html'
```

**URL**: `/contact/`
**권한**: 누구나 접근 가능

---

## Mixin 및 권한 관리

### 1. LoginRequiredMixin
로그인하지 않은 사용자가 접근 시 로그인 페이지로 리다이렉트합니다.

```python
from django.contrib.auth.mixins import LoginRequiredMixin

class MyView(LoginRequiredMixin, View):
    login_url = '/accounts/login/'  # 선택사항: 기본값은 settings.LOGIN_URL
```

**적용 뷰**:
- PostCreateView
- PostUpdateView
- PostDeleteView
- CommentCreateView
- CommentUpdateView
- CommentDeleteView

---

### 2. UserPassesTestMixin
사용자가 특정 조건을 만족하는지 확인합니다.

```python
from django.contrib.auth.mixins import UserPassesTestMixin

class MyView(UserPassesTestMixin, View):
    def test_func(self):
        # True 반환 시 접근 허용, False 반환 시 403 Forbidden
        return self.request.user == self.get_object().author
```

**적용 뷰**:
- PostUpdateView (작성자만 수정 가능)
- PostDeleteView (작성자만 삭제 가능)
- CommentUpdateView (작성자만 수정 가능)
- CommentDeleteView (작성자만 삭제 가능)

---

## 폼 클래스

### 1. PostForm
```python
from django import forms
from .models import Post

class PostForm(forms.ModelForm):
    class Meta:
        model = Post
        fields = ['title', 'content', 'tags', 'is_published']
        widgets = {
            'title': forms.TextInput(attrs={'class': 'form-control'}),
            'content': forms.Textarea(attrs={'class': 'form-control', 'rows': 10}),
            'tags': forms.CheckboxSelectMultiple(),
        }
```

---

### 2. CommentForm
```python
from django import forms
from .models import Comment

class CommentForm(forms.ModelForm):
    class Meta:
        model = Comment
        fields = ['content']
        widgets = {
            'content': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
        }
```

---

## settings.py 설정

```python
# 로그인/로그아웃 관련 설정
LOGIN_URL = '/accounts/login/'
LOGIN_REDIRECT_URL = '/'
LOGOUT_REDIRECT_URL = '/'
```

---

## 뷰 전체 요약표

| 뷰 이름 | 제네릭 뷰 | URL | 권한 | Mixin |
|---------|----------|-----|------|-------|
| HomeView | TemplateView | `/` | 누구나 | - |
| AboutView | TemplateView | `/about/` | 누구나 | - |
| ContactView | TemplateView | `/contact/` | 누구나 | - |
| SignUpView | CreateView | `/accounts/signup/` | 누구나 | - |
| LoginView | LoginView | `/accounts/login/` | 비로그인 | - |
| LogoutView | LogoutView | `/accounts/logout/` | 로그인 | - |
| PostListView | ListView | `/blog/` | 누구나 | - |
| PostDetailView | DetailView | `/blog/<pk>/` | 누구나 | - |
| PostCreateView | CreateView | `/blog/create/` | 로그인 | LoginRequiredMixin |
| PostUpdateView | UpdateView | `/blog/<pk>/update/` | 작성자 | LoginRequiredMixin, UserPassesTestMixin |
| PostDeleteView | DeleteView | `/blog/<pk>/delete/` | 작성자 | LoginRequiredMixin, UserPassesTestMixin |
| PostByTagListView | ListView | `/blog/tag/<slug>/` | 누구나 | - |
| CommentCreateView | CreateView | `/blog/<post_pk>/comment/create/` | 로그인 | LoginRequiredMixin |
| CommentUpdateView | UpdateView | `/blog/comment/<pk>/update/` | 작성자 | LoginRequiredMixin, UserPassesTestMixin |
| CommentDeleteView | DeleteView | `/blog/comment/<pk>/delete/` | 작성자 | LoginRequiredMixin, UserPassesTestMixin |

---

## 마크다운 지원

게시글 내용을 마크다운으로 작성하고 HTML로 렌더링하기 위해 `markdown` 라이브러리를 사용합니다.

### 설치
```bash
pip install markdown
```

### 템플릿 필터 생성
```python
# main/templatetags/markdown_extras.py
from django import template
import markdown as md

register = template.Library()

@register.filter(name='markdown')
def markdown_format(text):
    return md.markdown(text, extensions=['fenced_code', 'codehilite'])
```

### 템플릿에서 사용
```html
{% load markdown_extras %}

<div class="post-content">
    {{ post.content|markdown|safe }}
</div>
```
